<!DOCTYPE html>
<html>
<head>
    <title>SSO Test Parent</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .button-group {
            margin: 10px 0;
        }
        .button-group h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .sso-button {
            background-color: #28a745;
            font-weight: bold;
            padding: 10px 20px;
        }
        .sso-button:hover {
            background-color: #1e7e34;
        }
        iframe {
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>SSO Test Parent Window</h1>
    
    <div class="info">
        <strong>Instructions:</strong> Use the buttons below to navigate the iframe to different pages and test SSO functionality.
        The iframe will maintain its embedded state across navigation.
    </div>
    
    <div class="info" style="background-color: #fff3cd; border: 2px solid #ffdf7e; margin-top: 10px;">
        <strong>‚ÑπÔ∏è LAZY LOADING:</strong> The iframe will not load content until you click on a navigation button. When content is loaded, an SSO message will be sent automatically.
    </div>
    
    <div class="controls">
        <div class="button-group">
            <h3>üîê SSO Control</h3>
            <button class="sso-button" style="background-color: #dc3545;" onclick="sendExactDashboardMessage()">Send EXACT Dashboard Message</button>
            <button class="sso-button" onclick="sendSSOMessage('en')">Send SSO (English)</button>
            <button class="sso-button" onclick="sendSSOMessage('it')">Send SSO (Italian)</button>
            <button class="sso-button" onclick="sendSSOMessage('sp')">Send SSO (Spanish)</button>
            <button class="sso-button" onclick="sendSSOMessage('de')">Send SSO (German)</button>
            <button class="sso-button" onclick="sendRawSSOMessage('en')" style="background-color: #dc3545;">Send Raw JSON (English)</button>
        </div>
        
        <div class="button-group">
            <h3>üåê Language Only</h3>
            <button onclick="sendLanguageChangeOnly('en')">Change to English</button>
            <button onclick="sendLanguageChangeOnly('it')">Change to Italian</button>
            <button onclick="sendLanguageChangeOnly('sp')">Change to Spanish</button>
            <button onclick="sendLanguageChangeOnly('de')">Change to German</button>
        </div>
        
        <div class="button-group">
            <h3>üè† Main Pages</h3>
            <button onclick="navigateToPage('/pages/home')">Home</button>
            <button onclick="navigateToPage('/pages/datasets')">Data Catalogue</button>
            <button onclick="navigateToPage('/pages/catalogues')">Catalogues</button>
            <button onclick="navigateToPage('/pages/statistics')">Statistics</button>
        </div>
        
        <div class="button-group">
            <h3>üîç Data Tools</h3>
            <button onclick="navigateToPage('/pages/mqa')">Mqa Scoring</button>
            <button onclick="navigateToPage('/pages/sparql')">Sparql</button>
        </div>
        
        <div class="button-group">
            <h3>‚öôÔ∏è Administration</h3>
            <button onclick="navigateToPage('/pages/administration/adminCatalogues')">Data Catalogue Admin</button>
            <button onclick="navigateToPage('/pages/administration/dataletsManagement')">Datalet Admin</button>
            <button onclick="navigateToPage('/pages/administration/configuration')">Configurations Admin</button>
            <button onclick="navigateToPage('/pages/administration/datasets-ngsi')">Datasets NGSI</button>
            <button onclick="navigateToPage('/pages/administration/models-tools')">Models and Tools</button>
            <button onclick="navigateToPage('/pages/administration/data-sources')">Data Sources</button>
        </div>
        
        <div class="button-group">
            <h3>üîß Test Navigation</h3>
            <button onclick="navigateToPage('/')">Root Page</button>
            <button onclick="navigateToPage('/pages')">Pages Root</button>
            <button onclick="reloadIframe()">Reload Iframe</button>
        </div>
    </div>
    
    <div class="button-group">
        <h3>üîÑ Change Target Environment</h3>
        <button onclick="setIframeTarget('http://localhost:4200')">Local Environment</button>
        <button onclick="setIframeTarget('https://idra-dev.urbreath.tech')">Development Environment</button>
        <input type="text" id="customTarget" placeholder="Custom URL..." style="padding: 8px; margin: 5px;">
        <button onclick="setCustomIframeTarget()">Set Custom Target</button>
    </div>

    <iframe id="childFrame" src="about:blank" data-target="http://localhost:4200" width="100%" height="700" style="background-color: #f8f9fa; border: 2px dashed #ccc;"></iframe>
    
    <div id="initial-message" style="text-align: center; margin-top: -400px; position: relative; color: #6c757d;">
        <h2>üëÜ Select a navigation option above to load content</h2>
        <p>The iframe will load content and automatically send SSO credentials when you click a navigation button</p>
    </div>

    <script>
    // Track the currently selected language
    let currentLanguage = localStorage.getItem('testSsoLanguage') || 'en';
    
    // Function to update the tracked language
    function updateCurrentLanguage(language) {
        currentLanguage = language;
        try {
            localStorage.setItem('testSsoLanguage', language);
        } catch (e) {
            console.warn('Failed to save language to localStorage:', e);
        }
        console.log('Parent: Updated current language to:', language);
    }

    // Function to change the iframe target environment without loading content
    function setIframeTarget(baseUrl) {
        // Just store the target, don't load content yet
        document.getElementById('childFrame').setAttribute('data-target', baseUrl);
        console.log('Changed iframe target to:', baseUrl);
        
        // Show feedback to the user
        const initialMessage = document.getElementById('initial-message');
        initialMessage.innerHTML = `
            <h2>üëÜ Target set to: ${baseUrl}</h2>
            <p>Now select a navigation option above to load content</p>
        `;
        initialMessage.style.display = 'block';
        
        // Reset iframe to blank
        document.getElementById('childFrame').src = 'about:blank';
        document.getElementById('childFrame').style.borderColor = '#ccc';
        document.getElementById('childFrame').style.borderStyle = 'dashed';
    }
    
    // Function to set custom iframe target
    function setCustomIframeTarget() {
        const customUrl = document.getElementById('customTarget').value;
        if (customUrl) {
            setIframeTarget(customUrl);
        } else {
            alert('Please enter a valid URL');
        }
    }
// Function to simulate the exact message from dashboard-dev.urbreath.tech
function sendExactDashboardMessage(isAutomatic = false) {
    const logPrefix = isAutomatic ? 'AUTO-SSO:' : 'Parent:';
    console.log(`${logPrefix} Sending EXACT message from dashboard-dev.urbreath.tech`);
    
    // Create an exact copy of the dashboard message
    const dashboardMessage = {
        embedded: true,
        accessToken: 'eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJfWVJZTDRYMC16RVhlUEZOQnVENzVnc0dvU0VRWGNHUnZxOVR0VlZxYnlvIn0.eyJleHAiOjE2OTQxNzUwMDUsImlhdCI6MTY5NDA4ODYwNSwianRpIjoiZjliNTRkZTAtNGQyMy00YTk3LWI5MzYtNTBkZTg1YTI2ZTFhIiwiaXNzIjoiaHR0cHM6Ly9pZG0ub3BzaWxhYi5pdC9hdXRoL3JlYWxtcy9nYWxpbGVvIiwiYXVkIjpbImZyYW1ld29yay1ibHVlcHJpbnQtYXBwIiwia2V5Y2xvYWstaWRtIiwiYWNjb3VudCIsInRlc3QtY2xpZW50Il0sInN1YiI6IjNmOWIxMzZlLWY1ZjEtNDFjNy05YjVjLWMyMTM4MGYwM2Q4IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoicG9ydGFsIiwic2Vzc2lvbl9zdGF0ZSI6ImYwYzU4NWFmLWEyZGMtNGZjYy04NDg3LTdiM2NkMjY2YmFmYiIsImFsbG93ZWQtb3JpZ2lucyI6WyIqIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsInVtYV9hdXRob3JpemF0aW9uIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsia2V5Y2xvYWstaWRtIjp7InJvbGVzIjpbInZpZXctcmVhbG0iLCJ2aWV3LWlkZW50aXR5LXByb3ZpZGVycyIsIm1hbmFnZS1pZGVudGl0eS1wcm92aWRlcnMiLCJpbXBlcnNvbmF0aW9uIiwiY3JlYXRlLWNsaWVudCIsIm1hbmFnZS11c2VycyIsInF1ZXJ5LXJlYWxtcyIsInZpZXctYXV0aG9yaXphdGlvbiIsInF1ZXJ5LWNsaWVudHMiLCJxdWVyeS11c2VycyIsIm1hbmFnZS1ldmVudHMiLCJtYW5hZ2UtcmVhbG0iLCJ2aWV3LWV2ZW50cyIsInZpZXctdXNlcnMiLCJ2aWV3LWNsaWVudHMiLCJtYW5hZ2UtYXV0aG9yaXphdGlvbiIsIm1hbmFnZS1jbGllbnRzIiwicXVlcnktZ3JvdXBzIl19LCJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6Im9wZW5pZCBwcm9maWxlIGVtYWlsIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInByZWZlcnJlZF91c2VybmFtZSI6ImFkbWluIiwiZW1haWwiOiJhZG1pbkBleGFtcGxlLmNvbSIsIm5hbWUiOiJKb2huIERvZSJ9.ApcqQJk9XwMhov7qj5OrTsQZpQLQNNgep4eBiJ5Y80FdxRTfV0YgMBDJQCbhLaUUAHQclG4tLWjaqFitdN3VGUBsqyv8ja1i7XWOfIo4r2qcSuJIdxtidJRwt8COdzwmkRr7BFnDGpGlW7Dt_PJT6V_5CmK4smmrS7lJBeyqQ-5BYv-TOQ61TA9uWgMh0ctX-7hRupLBlotMvHj54JTtXRDCnYXMZVePAJjYxVqQ-OwYWDyl6oQSPd-Znkug0erQ-brX8GYXXXshFAL0mnx8w7WgJKuEzrbKxsVk9h6gb4zSXNhX5VXFqA1Dqdg1jQoQtYpO4aoctNe_yZVkqEoaYVd4iEkYwPInhqw',
        refreshToken: 'eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJlMjZhMGM3ZC0yYmVhLTRhZjItOTJiYy1kNzExOGM4ZGY2OCJ9.eyJpYXQiOjE2OTQwODg2MDUsImp0aSI6ImI1MWRhYjk0LTNhZjctNGI4NS05MWQ3LTU4ZTQ2ZTZmZDY5OCIsImlzcyI6Imh0dHBzOi8vaWRtLm9wc2lsYWIuaXQvYXV0aC9yZWFsbXMvZ2FsaWxlbyIsImF1ZCI6Imh0dHBzOi8vaWRtLm9wc2lsYWIuaXQvYXV0aC9yZWFsbXMvZ2FsaWxlbyIsInN1YiI6IjNmOWIxMzZlLWY1ZjEtNDFjNy05YjVjLWMyMTM4MGYwM2Q4IiwidHlwIjoiUmVmcmVzaCIsImF6cCI6InBvcnRhbCIsInNlc3Npb25fc3RhdGUiOiJmMGM1ODVhZi1hMmRjLTRmY2MtODQ4Ny03YjNjZDI2NmJhZmIiLCJzY29wZSI6Im9wZW5pZCBwcm9maWxlIGVtYWlsIiwic2lkIjoiZjBjNTg1YWYtYTJkYy00ZmNjLTg0ODctN2IzY2QyNjZiYWZiIn0.2cZQt_fj_Ymt2h2mCJcvBcvAwkbUXDG5CsvRb_CC7n4',
        language: currentLanguage,
        sideMenu: 'expanded'
    };
    
    const iframe = document.getElementById('childFrame');
    const iframeOrigin = new URL(iframe.src).origin;
    
    // Function to send messages in rapid sequence
    function sendMessagesInSequence() {
        try {
            // Send the first message
            iframe.contentWindow.postMessage(dashboardMessage, iframeOrigin);
            console.log(`${logPrefix} First EXACT dashboard message sent to ${iframeOrigin}`);
            
            // Send the second message immediately after (50ms delay)
            setTimeout(() => {
                iframe.contentWindow.postMessage(dashboardMessage, iframeOrigin);
                console.log(`${logPrefix} Second EXACT dashboard message sent (rapid sequence)`);
            }, 50);
        } catch (error) {
            console.error(`${logPrefix} Error sending message:`, error);
        }
    }
    
    // If the iframe is still loading, wait for it to finish
    if (iframe.contentWindow && iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
        sendMessagesInSequence();
    } else {
        console.log(`${logPrefix} Iframe not fully loaded, waiting...`);
        setTimeout(sendMessagesInSequence, 50);
    }
}

function sendSSOMessage(language = 'en') {
    console.log('Parent: Preparing to send SSO message with language:', language);
    
    // Update the tracked language
    updateCurrentLanguage(language);
    
    // Creating an SSO message that exactly matches the dashboard-dev.urbreath.tech format
    const ssoMessage = {
        embedded: true,
        accessToken: 'eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJfWVJZTDRYMC16RVhlUEZOQnVENzVnc0dvU0VRWGNHUnZxOVR0VlZxYnlvIn0.eyJleHAiOjE2OTQxNzUwMDUsImlhdCI6MTY5NDA4ODYwNSwianRpIjoiZjliNTRkZTAtNGQyMy00YTk3LWI5MzYtNTBkZTg1YTI2ZTFhIiwiaXNzIjoiaHR0cHM6Ly9pZG0ub3BzaWxhYi5pdC9hdXRoL3JlYWxtcy9nYWxpbGVvIiwiYXVkIjpbImZyYW1ld29yay1ibHVlcHJpbnQtYXBwIiwia2V5Y2xvYWstaWRtIiwiYWNjb3VudCIsInRlc3QtY2xpZW50Il0sInN1YiI6IjNmOWIxMzZlLWY1ZjEtNDFjNy05YjVjLWMyMTM4MGYwM2Q4IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoicG9ydGFsIiwic2Vzc2lvbl9zdGF0ZSI6ImYwYzU4NWFmLWEyZGMtNGZjYy04NDg3LTdiM2NkMjY2YmFmYiIsImFsbG93ZWQtb3JpZ2lucyI6WyIqIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsInVtYV9hdXRob3JpemF0aW9uIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsia2V5Y2xvYWstaWRtIjp7InJvbGVzIjpbInZpZXctcmVhbG0iLCJ2aWV3LWlkZW50aXR5LXByb3ZpZGVycyIsIm1hbmFnZS1pZGVudGl0eS1wcm92aWRlcnMiLCJpbXBlcnNvbmF0aW9uIiwiY3JlYXRlLWNsaWVudCIsIm1hbmFnZS11c2VycyIsInF1ZXJ5LXJlYWxtcyIsInZpZXctYXV0aG9yaXphdGlvbiIsInF1ZXJ5LWNsaWVudHMiLCJxdWVyeS11c2VycyIsIm1hbmFnZS1ldmVudHMiLCJtYW5hZ2UtcmVhbG0iLCJ2aWV3LWV2ZW50cyIsInZpZXctdXNlcnMiLCJ2aWV3LWNsaWVudHMiLCJtYW5hZ2UtYXV0aG9yaXphdGlvbiIsIm1hbmFnZS1jbGllbnRzIiwicXVlcnktZ3JvdXBzIl19LCJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6Im9wZW5pZCBwcm9maWxlIGVtYWlsIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInByZWZlcnJlZF91c2VybmFtZSI6ImFkbWluIiwiZW1haWwiOiJhZG1pbkBleGFtcGxlLmNvbSIsIm5hbWUiOiJKb2huIERvZSJ9.ApcqQJk9XwMhov7qj5OrTsQZpQLQNNgep4eBiJ5Y80FdxRTfV0YgMBDJQCbhLaUUAHQclG4tLWjaqFitdN3VGUBsqyv8ja1i7XWOfIo4r2qcSuJIdxtidJRwt8COdzwmkRr7BFnDGpGlW7Dt_PJT6V_5CmK4smmrS7lJBeyqQ-5BYv-TOQ61TA9uWgMh0ctX-7hRupLBlotMvHj54JTtXRDCnYXMZVePAJjYxVqQ-OwYWDyl6oQSPd-Znkug0erQ-brX8GYXXXshFAL0mnx8w7WgJKuEzrbKxsVk9h6gb4zSXNhX5VXFqA1Dqdg1jQoQtYpO4aoctNe_yZVkqEoaYVd4iEkYwPInhqw',
        refreshToken: 'eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJlMjZhMGM3ZC0yYmVhLTRhZjItOTJiYy1kNzExOGM4ZGY2OCJ9.eyJpYXQiOjE2OTQwODg2MDUsImp0aSI6ImI1MWRhYjk0LTNhZjctNGI4NS05MWQ3LTU4ZTQ2ZTZmZDY5OCIsImlzcyI6Imh0dHBzOi8vaWRtLm9wc2lsYWIuaXQvYXV0aC9yZWFsbXMvZ2FsaWxlbyIsImF1ZCI6Imh0dHBzOi8vaWRtLm9wc2lsYWIuaXQvYXV0aC9yZWFsbXMvZ2FsaWxlbyIsInN1YiI6IjNmOWIxMzZlLWY1ZjEtNDFjNy05YjVjLWMyMTM4MGYwM2Q4IiwidHlwIjoiUmVmcmVzaCIsImF6cCI6InBvcnRhbCIsInNlc3Npb25fc3RhdGUiOiJmMGM1ODVhZi1hMmRjLTRmY2MtODQ4Ny03YjNjZDI2NmJhZmIiLCJzY29wZSI6Im9wZW5pZCBwcm9maWxlIGVtYWlsIiwic2lkIjoiZjBjNTg1YWYtYTJkYy00ZmNjLTg0ODctN2IzY2QyNjZiYWZiIn0.2cZQt_fj_Ymt2h2mCJcvBcvAwkbUXDG5CsvRb_CC7n4',
        language: language,
        sideMenu: 'expanded' // Exactly as seen in the parent application message
    };
    
    const iframe = document.getElementById('childFrame');
    
    // Send the message twice in rapid sequence to mimic the main component behavior
    iframe.contentWindow.postMessage(ssoMessage, 'http://localhost:4200');
    console.log('Parent: First SSO message sent to iframe as object');
    
    // Send the second message immediately after the first one
    setTimeout(() => {
        iframe.contentWindow.postMessage(ssoMessage, 'http://localhost:4200');
        console.log('Parent: Second SSO message sent to iframe (rapid sequence)');
    }, 50); // Very short delay between messages
}

function sendLanguageChangeOnly(language) {
    console.log('Parent: Sending language change message:', language);
    
    // Update the tracked language
    updateCurrentLanguage(language);
    
    // Create a language change message that maintains the same format as the SSO message
    // but only updates the language field
    const languageMessage = {
        embedded: true,
        language: language,
        sideMenu: 'expanded' // Maintaining the sideMenu property for consistency
    };
    
    const iframe = document.getElementById('childFrame');
    
    // Send the message twice in rapid sequence to mimic the main component behavior
    iframe.contentWindow.postMessage(languageMessage, 'http://localhost:4200');
    console.log('Parent: First language change message sent');
    
    // Send the second message immediately after
    setTimeout(() => {
        iframe.contentWindow.postMessage(languageMessage, 'http://localhost:4200');
        console.log('Parent: Second language change message sent (rapid sequence)');
    }, 50); // Very short delay between messages
}

// Listen for messages from the iframe for debugging - with proper filtering
window.addEventListener('message', function(event) {
    // Only log messages from our iframe and that are relevant
    if (event.source === document.getElementById('childFrame').contentWindow) {
        // Filter out known message types that should be ignored
        if (event.data && 
            (event.data.type === 'webpackOk' || 
             event.data.type === 'webpackInvalid' ||
             event.data.type === 'webpackWarnings' ||
             event.data.type === 'webpackErrors' ||
             event.data.__fromDevtools ||
             event.data.source === 'react-devtools-bridge' ||
             event.data.source === 'react-devtools-content-script' ||
             event.origin === 'http://127.0.0.1:5500')) {
            // Ignore these messages
            return;
        }
        
        console.log('Parent: Relevant message received from iframe:', event.data);
    }
});

// Navigation functions
function navigateToPage(path) {
    const iframe = document.getElementById('childFrame');
    
    // Hide initial message when content is loaded
    document.getElementById('initial-message').style.display = 'none';
    
    // Get the base URL from the data-target attribute or use default
    let baseUrl = iframe.getAttribute('data-target') || 'http://localhost:4200';
    
    // If we don't have a data-target attribute but iframe has a non-blank src, use that origin
    if (!iframe.hasAttribute('data-target') && iframe.src !== 'about:blank' && !iframe.src.includes('about:blank')) {
        try {
            baseUrl = new URL(iframe.src).origin;
        } catch (e) {
            console.log('Using default URL:', baseUrl);
        }
    }
    
    const newUrl = `${baseUrl}${path}?embedded=true`;
    console.log('Parent: Navigating iframe to:', newUrl);
    
    // Set the source of the iframe
    iframe.src = newUrl;
    
    // Set up a one-time load event handler to send SSO message after navigation
    iframe.onload = function() {
        console.log('Parent: Iframe loaded after navigation - sending dashboard message');
        
        // Remove this onload handler after execution (to make it one-time)
        setTimeout(() => {
            iframe.onload = null;
            
            // Send the dashboard message
            sendExactDashboardMessage(true);
            
            // Highlight the iframe to show it's loaded
            iframe.style.borderColor = '#28a745';
            iframe.style.borderStyle = 'solid';
        }, 800); // Short delay to ensure page has initialized
    };
}

function reloadIframe() {
    const iframe = document.getElementById('childFrame');
    
    // Only reload if there's actual content (not about:blank)
    if (iframe.src && iframe.src !== 'about:blank' && !iframe.src.includes('about:blank')) {
        const currentSrc = iframe.src;
        console.log('Parent: Reloading iframe from:', currentSrc);
        
        // Set up onload handler to send SSO message after reload
        iframe.onload = function() {
            console.log('Parent: Iframe reloaded - sending dashboard message');
            setTimeout(() => {
                iframe.onload = null;
                sendExactDashboardMessage(true);
            }, 800);
        };
        
        // Reload by setting the same src
        iframe.src = currentSrc;
    } else {
        alert('Please navigate to a page first before reloading');
    }
}

// Function to send the SSO message as a raw JSON string
function sendRawSSOMessage(language = 'en') {
    console.log('Parent: Preparing to send RAW JSON SSO message with language:', language);
    
    // Update the tracked language
    updateCurrentLanguage(language);
    
    // Creating an SSO message that exactly matches the dashboard-dev.urbreath.tech format
    const ssoMessage = {
        embedded: true,
        accessToken: 'eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIzZjlIMzZlLWY1ZjEtNDFjNy05YjVjLWMyMTM4MGYwM2Q4In0.eyJleHAiOjE2OTM0OTA4NTksImlhdCI6MTY5MzQ1NDg1OSwianRpIjoiOGJlNjVmODgtODAwNi00MzZlLTgxNjgtN2Q0NmZkZTllYTc3IiwiaXNzIjoiaHR0cHM6Ly9pZG0ub3BzaWxhYi5pdC9hdXRoL3JlYWxtcy91cmJyZWF0aCIsInN1YiI6IjNmOWIxMzZlLWY1ZjEtNDFjNy05YjVjLWMyMTM4MGYwM2Q4IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiZGFzaGJvYXJkIiwic2Vzc2lvbl9zdGF0ZSI6IjQ1OWE2MTJkLTQ2OTgtNGVhNi04ZGMzLTVmMjVlNDQ0NGM2YiIsImFjciI6IjEiLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwic2NvcGUiOiJlbWFpbCBwcm9maWxlIiwic2lkIjoiNDU5YTYxMmQtNDY5OC00ZWE2LThkYzMtNWYyNWU0NDQ0YzZiIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsIm5hbWUiOiJKb2huIERvZSIsInByZWZlcnJlZF91c2VybmFtZSI6ImpvaG5kb2UiLCJnaXZlbl9uYW1lIjoiSm9obiIsImZhbWlseV9uYW1lIjoiRG9lIiwiZW1haWwiOiJqb2huLmRvZUBleGFtcGxlLmNvbSJ9.XfUzmbodKREj7Xw89M7LyR7Q_HlrTNOjMvOe3X-lzkBj2_rwvxJB-sOJsO5NHRFnWpvN0Gkdh7QZLGbNf8kZeA8fmV24SOsXUxUJnZweTbZslzGIQ9X0Ek94NdfXFCtyIW-LWhsPW3JTHmN9lQq3KO39HGKU42PAsKWiyXXmiQxd02H4jFmGvnPfNzuZYi3b5IaTHkQaCIAA3nfvG8_pQK6OuqRZp_hws8KPxZHFDeQHmZZg6gbH9Bn5aDpYQOgaTXFqA1Dqdg1jQoQtYpO4aoctNe_yZVkqEoaYVd4iEkYwPInhqw',
        refreshToken: 'eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIzZjlIMzZlLWY1ZjEtNDFjNy05YjVjLWMyMTM4MGYwM2Q4In0.eyJpYXQiOjE2OTM0NTQ4NTksImp0aSI6ImY2N2Y5NDdmLWZlOTgtNDdhNS04ZTA0LTIzMjU1ZWJhOTQ4YyIsImlzcyI6Imh0dHBzOi8vaWRtLm9wc2lsYWIuaXQvYXV0aC9yZWFsbXMvdXJicmVhdGgiLCJhdWQiOiJodHRwczovL2lkbS5vcHNpbGFiLml0L2F1dGgvcmVhbG1zL3VyYnJlYXRoIiwic3ViIjoiM2Y5YjEzNmUtZjVmMS00MWM3LTliNWMtYzIxMzgwZjAzZDgiLCJ0eXAiOiJSZWZyZXNoIiwiYXpwIjoiZGFzaGJvYXJkIiwic2Vzc2lvbl9zdGF0ZSI6IjQ1OWE2MTJkLTQ2OTgtNGVhNi04ZGMzLTVmMjVlNDQ0NGM2YiIsInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsInNpZCI6IjQ1OWE2MTJkLTQ2OTgtNGVhNi04ZGMzLTVmMjVlNDQ0NGM2YiJ9.2cZQt_fj_Ymt2h2mCJcvBcvAwkbUXDG5CsvRb_CC7n4',
        language: language,
        sideMenu: 'expanded'
    };
    
    // Convert to JSON string and send as raw string
    const jsonString = JSON.stringify(ssoMessage);
    
    const iframe = document.getElementById('childFrame');
    
    // Send the message twice in rapid sequence
    iframe.contentWindow.postMessage(jsonString, 'http://localhost:4200');
    console.log('Parent: First raw JSON SSO message sent');
    
    // Send the second message immediately after
    setTimeout(() => {
        iframe.contentWindow.postMessage(jsonString, 'http://localhost:4200');
        console.log('Parent: Second raw JSON SSO message sent (rapid sequence)');
    }, 50); // Very short delay between messages
}

// Automatically send the exact dashboard message when the iframe loads
document.getElementById('childFrame').onload = function() {
    console.log('Parent: Iframe loaded - automatically sending exact dashboard message');
    
    // Check if iframe has actual content (not about:blank)
    const iframe = document.getElementById('childFrame');
    if (iframe.src && iframe.src !== 'about:blank' && !iframe.src.includes('about:blank')) {
        // Check for an sso_language in the iframe's localStorage (if same origin)
        try {
            // Try to read from iframe's localStorage if possible (same origin)
            const iframeLanguage = iframe.contentWindow.localStorage.getItem('sso_language');
            if (iframeLanguage) {
                console.log('Parent: Detected language in iframe:', iframeLanguage);
                updateCurrentLanguage(iframeLanguage);
            }
        } catch (e) {
            // Cross-origin access error, can't read iframe's localStorage
            console.log('Parent: Cannot access iframe localStorage (expected for cross-origin)');
        }
    }
    
    // Use a message event listener to receive language updates from the iframe
    window.addEventListener('message', function languageSync(event) {
        // Check if the message is from our iframe
        if (event.source === iframe.contentWindow) {
            // Check for language update messages
            if (event.data && event.data.type === 'idra-language-update' && event.data.language) {
                console.log('Parent: Received language update from iframe:', event.data.language);
                updateCurrentLanguage(event.data.language);
            }
        }
    });
    
    // Short delay to ensure iframe is fully loaded
    setTimeout(() => {
        sendExactDashboardMessage(true);  // Pass true to indicate automatic sending
    }, 500);
};

// Add event listeners to the language buttons to update the currentLanguage
document.addEventListener('DOMContentLoaded', function() {
    const languageButtons = document.querySelectorAll('.button-group button');
    languageButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Extract language from button text or onclick attribute
            const onclickAttr = this.getAttribute('onclick') || '';
            const languageMatch = onclickAttr.match(/['"](en|it|sp|de)['"]/);
            if (languageMatch) {
                const language = languageMatch[1];
                console.log('Parent: Language button clicked:', language);
                updateCurrentLanguage(language);
            }
        });
    });
});
    </script>
</body>
</html>