<div>
  <nb-stepper #stepper orientation="horizontal" [(selectedIndex)]="selectedStepIndex" class="stepper-container custom-stepper" (stepChange)="onStepChange($event.index)">
    
    <!-- Step 1: Add Distributions -->
    <nb-step label="Add distributions">
      <div class="step-content">
        <nb-card class="m-0 w-50">
        <!-- Left panel: distribution form -->
        <form [formGroup]="distributionForm" id="distributionForm" class="distribution-form">
          <nb-card-header>
            {{ isEditingDistribution ? 'Edit Distribution' : 'Create New Distribution' }}
          </nb-card-header>
          
          <label for="distId">ID (optional)</label>
          <input nbInput id="distId" formControlName="id" type="text" class="full-width-input" />
          
          <label for="title" class="required-field">Title</label>
          <input nbInput 
                 id="title" 
                 formControlName="title" 
                 type="text" 
                 class="full-width-input"
                 [status]="isFieldInvalid('title') ? 'danger' : 'basic'" />
          <div *ngIf="isFieldInvalid('title')" class="error-message">
            Title is required
          </div>
          
          <label for="description">Description</label>
          <textarea nbInput id="description" formControlName="description" class="full-width-input"></textarea>
          
          <label for="downloadURL" class="required-field">Download URL</label>
          <input nbInput 
                 id="downloadURL" 
                 formControlName="downloadURL" 
                 type="text" 
                 class="w-100"
                 [status]="isFieldInvalid('downloadURL') ? 'danger' : 'basic'" />
          <div *ngIf="isFieldInvalid('downloadURL')" class="error-message">
            Download URL is required
          </div>
          
          
          <label for="format">Format</label>
          <nb-select 
            id="format"
            formControlName="format"
            class="form-control">
            <nb-option *ngFor="let option of formatOptions" [value]="option">
              {{ option }}
            </nb-option>
          </nb-select>
          
          <label for="license">License</label>
          <input nbInput id="license" formControlName="license" type="text" class="full-width-input" />
          
          <label for="releaseDate">Release Date</label>
          <input nbInput placeholder="yyyy-MM-dd" id="releaseDate" formControlName="releaseDate" 
                 [nbDatepicker]="releaseDatePicker" class="full-width-input" />
          <nb-datepicker #releaseDatePicker (dateChange)="onDateSelect($event, 'releaseDate')"></nb-datepicker>
          
          <div class="form-actions">
            <button nbButton
              type="submit"
              status="primary"
              [disabled]="distributionForm.invalid"
              (click)="saveDistributionToLocalStorage()">
              {{ isEditingDistribution ? 'Save Changes' : 'Add to List' }}
            </button>
            
            <button *ngIf="isEditingDistribution"
              nbButton
              type="button"
              status="basic"
              class="ml-2"
              (click)="cancelEditDistribution()">
              Cancel
            </button>
          </div>
        </form>
      </nb-card>

        <!-- Right panel: distribution list -->
        <nb-card class="distribution-list-panel m-0">
          <div class="distribution-list-header">
            <div>
              <h4>Distribution list</h4>
              <p *ngIf="distributions.length === 0">No distributions added yet</p>
            </div>
            
          </div>
          <ul>
            <li *ngFor="let dist of distributions; let i = index" class="distribution-item" 
                [class.marked-for-deletion]="dist.markedForDeletion"
                [class.current-editing]="isEditingDistribution && currentEditingDistributionId === dist.id">
              <div>
                <strong>{{ dist.title }} (ID: {{ dist.id }})</strong>
                <p>{{ dist.description }}</p>
                <span *ngIf="dist.markedForDeletion" class="deletion-badge">Pending Deletion</span>
                <span *ngIf="isEditingDistribution && currentEditingDistributionId === dist.id" class="editing-badge">Currently Editing</span>
              </div>
              <div class="distribution-actions">
                <button nbButton 
                      [status]="dist.markedForDeletion ? 'success' : 'danger'"
                      size="small"
                      [disabled]="deletingDistributions[dist.id] || (isEditingDistribution && currentEditingDistributionId === dist.id)" 
                      (click)="dist.markedForDeletion ? undoDeleteDistribution(i) : removeDistribution(i)">
                  <nb-icon *ngIf="!deletingDistributions[dist.id]" 
                           [icon]="dist.markedForDeletion ? 'undo-outline' : 'close-outline'"></nb-icon>
                  <nb-icon *ngIf="deletingDistributions[dist.id]" icon="loader-outline" [spin]="true"></nb-icon>
                </button>
                <button nbButton 
                       status="info" 
                       size="small" 
                       (click)="editDistribution(dist)" 
                       [disabled]="deletingDistributions[dist.id] || dist.markedForDeletion || (isEditingDistribution && currentEditingDistributionId === dist.id)">
                  <nb-icon icon="edit-outline"></nb-icon> Edit
                </button>
              </div>
            </li>
          </ul>
        </nb-card>
      </div>
      <div class="step-controls">
        <button nbButton [routerLink]="['/pages/datasets-ngsi']" >
          Back
        </button>
        <button nbButton  (click)="stepper.next()">
          Next
        </button>
      </div>
    </nb-step>
    
    <!-- Step 2: Create Dataset -->
    <nb-step label="Create dataset">
      <div class="step-content">
          <form [formGroup]="datasetForm" class="dataset-form">
            <div class="left-column">
              <label for="title" class="required-field">Title </label>
              <input nbInput fullWidth id="title" formControlName="title">
                        
              <label for="datasetId" >ID (optional)</label>
              <input nbInput fullWidth id="datasetId" formControlName="id">
                       
              <label for="description">Description</label>
              <textarea nbInput id="description" formControlName="description" fullWidth></textarea>
            
              <label for="version">
                Version
                <nb-icon
                  icon="info-outline"
                  status="primary" 
                  [nbTooltip]="'The version number or identifier of the dataset'"
                  nbTooltipStatus="primary">
                </nb-icon>
              </label>
              <input nbInput id="version" formControlName="version" type="text" fullWidth />
            
              <label>
                Keywords
                <nb-icon
                  icon="info-outline"
                  status="primary" 
                  [nbTooltip]="'Descriptive terms that might help other users in discovering the dataset'"
                  nbTooltipStatus="primary">
                </nb-icon>
              </label>
              <div class="keywords-container">
                <!-- Display tags -->
                <div class="keywords-tags" *ngIf="keywordArray.length > 0">
                  <nb-tag *ngFor="let keyword of keywordArray; let i = index"
                          [text]="keyword"
                          appearance="filled"
                          size="medium"
                          removable
                          (remove)="removeKeywordTag(keyword)">
                  </nb-tag>
                </div>
              
                <!-- Input field and button -->
                <div class="keywords-input-group">
                  <input nbInput
                        fullWidth
                        #keywordInput
                        placeholder="Type keyword"
                        class="keyword-input" />
                  <button nbButton
                          status="info"
                          size="small"
                          (click)="addKeywordFromInput(keywordInput)">
                    <nb-icon icon="plus-outline"></nb-icon>
                  </button>
                </div>
              </div>
            </div>
          
            <div class="mid-column">
              <label for="name">Name</label>
              <input nbInput id="name" formControlName="name" type="text" fullWidth />
              
              <label for="publisher">Publisher</label>
              <input nbInput id="publisher" formControlName="publisher" type="text" fullWidth />
              
              <label>Contact Points</label>
              <div class="contact-points-container">
                <!-- Display tags -->
                <div class="contact-points-tags" *ngIf="contactPointArray.length > 0">
                  <nb-tag *ngFor="let contact of contactPointArray"
                          [text]="contact"
                          appearance="filled"
                          size="medium"
                          removable
                          (remove)="removeContactPointTag(contact)">
                  </nb-tag>
                </div>
                
                <!-- Input field and button -->
                <div class="contact-points-input-group">
                  <input nbInput
                        fullWidth
                        #contactInput
                        placeholder="Type contact point"
                        class="contact-input" />
                  <button nbButton
                          status="info"
                          size="small"
                          (click)="addContactPointFromInput(contactInput)">
                    <nb-icon icon="plus-outline"></nb-icon>
                  </button>
                </div>
              </div>
              
              <label for="creator">Creator</label>
              <input nbInput id="creator" formControlName="creator" type="text" fullWidth />
              
              <div class="form-group">
                <label for="releaseDate" class="required-field">Release Date</label>
                <input nbInput fullWidth id="releaseDate" formControlName="releaseDate"
                      [nbDatepicker]="datepicker">
                <nb-datepicker #datepicker></nb-datepicker>
              </div>
            </div>
            <div class="right-column">
              <label>
                Themes
                <nb-icon
                  icon="info-outline"
                  status="primary" 
                  [nbTooltip]="'EU Categories that classify the dataset content'"
                  nbTooltipStatus="primary">
                </nb-icon>
              </label>
              <nb-select multiple fullWidth formControlName="theme" placeholder="Select themes">
                <nb-option value="AGRI">Agriculture</nb-option>
                <nb-option value="ECON">Economy</nb-option>
                <nb-option value="EDUC">Education</nb-option>
                <nb-option value="ENVI">Environment</nb-option>
                <nb-option value="ENER">Energy</nb-option>
                <nb-option value="GOVE">Government</nb-option>
                <nb-option value="HEAL">Health</nb-option>
                <nb-option value="JUST">Justice</nb-option>
                <nb-option value="INTR">International</nb-option>
                <nb-option value="REGI">Regions</nb-option>
                <nb-option value="SOCI">Society</nb-option>
                <nb-option value="TECH">Technology</nb-option>
                <nb-option value="TRAN">Transportation</nb-option>
              </nb-select>
              
              <div class="form-group">
                <label for="frequency">
                  Frequency
                  <nb-icon
                    icon="info-outline"
                    status="primary" 
                    [nbTooltip]="'The frequency with which this dataset gets updated'"
                    nbTooltipStatus="primary">
                  </nb-icon>
                </label>
                <nb-select id="frequency" formControlName="frequency" class="full-width-input" placeholder="Select frequency">
                  <nb-option>none</nb-option>
                  <nb-option value="DAILY">Daily</nb-option>
                  <nb-option value="WEEKLY">Weekly</nb-option>
                  <nb-option value="MONTHLY">Monthly</nb-option>
                </nb-select>
              </div>
              
              <!-- Spatial / map area -->
              <div class="spatial-section">
                <strong class="required-field">
                  Spatial:
                  <nb-icon
                    icon="info-outline"
                    status="primary" 
                    [nbTooltip]="'Geographic location that the dataset covers'"
                    nbTooltipStatus="primary">
                  </nb-icon>
                </strong>
                <div formArrayName="spatial" *ngFor="let point of spatialPoints.controls; let i = index">
                  <div [formGroupName]="i" class="spatial-point">
                    <div formArrayName="coordinates" class="coordinates-input">
                      <div class="coordinate">
                        <label>Longitude:</label>
                        <input nbInput type="number" step="0.000001" [formControlName]="0" class="full-width-input" />
                      </div>
                      <div class="coordinate">
                        <label>Latitude:</label>
                        <input nbInput type="number" step="0.000001" [formControlName]="1" class="full-width-input" />
                      </div>
                    </div>
                  </div>
                </div>
                <div id="map"></div>
              </div>
            </div>
        </form>
      </div>
      <div class="step-controls">
        <button nbButton status="primary" (click)="stepper.previous()">
          Back
        </button>
        <button nbButton 
          class="green-button"
          status="success" 
          [disabled]="!isDatasetFormValid() || isCreatingDataset"
          (click)="createDatasetWithDistributions()">
          <nb-icon *ngIf="isCreatingDataset" icon="loader-outline" [spin]="true"></nb-icon>
          {{ isEditing ? 'Update dataset' : 'Create dataset' }}
        </button>
      </div>
    </nb-step>
  </nb-stepper>
</div>
