<div>
  <nb-stepper #stepper orientation="horizontal" [(selectedIndex)]="selectedStepIndex" class="stepper-container custom-stepper" (stepChange)="onStepChange($event.index)">
    
    <!-- Step 1: Add Distributions -->
    <nb-step label="Add distributions">
      <div class="step-content">
        <nb-card class="m-0 w-50">
        <!-- Left panel: distribution form -->
        <form [formGroup]="distributionForm" id="distributionForm" class="distribution-form">
          <nb-card-header>
            {{ isEditingDistribution ? 'Edit Distribution' : 'Create New Distribution' }}
          </nb-card-header>
          
          <label for="distId" class="required-field">ID</label>
          <input nbInput id="distId" formControlName="id" type="text" class="full-width-input" />
          
          <label for="title" class="required-field">Title</label>
          <input nbInput 
                 id="title" 
                 formControlName="title" 
                 type="text" 
                 class="full-width-input"
                 [status]="isFieldInvalid('title') ? 'danger' : 'basic'" />
          <div *ngIf="isFieldInvalid('title')" class="error-message">
            Title is required
          </div>
          
          <label for="description">Description</label>
          <textarea nbInput id="description" formControlName="description" class="full-width-input"></textarea>
          
          <label for="downloadURL" class="required-field">Download URL</label>
          <input nbInput 
                 id="downloadURL" 
                 formControlName="downloadURL" 
                 type="text" 
                 class="full-width-input"
                 [status]="isFieldInvalid('downloadURL') ? 'danger' : 'basic'" />
          <div *ngIf="isFieldInvalid('downloadURL')" class="error-message">
            Download URL is required
          </div>
          
          <div class="form-group">
            <label for="format">Format</label>
            <select 
              id="format"
              formControlName="format"
              class="form-control">
              <option *ngFor="let option of formatOptions" [value]="option">
                {{ option }}
              </option>
            </select>
          </div>
          
          <label for="license">License</label>
          <input nbInput id="license" formControlName="license" type="text" class="full-width-input" />
          
          <label for="releaseDate">Release Date</label>
          <input nbInput placeholder="yyyy-MM-dd" id="releaseDate" formControlName="releaseDate" 
                 [nbDatepicker]="releaseDatePicker" class="full-width-input" />
          <nb-datepicker #releaseDatePicker (dateChange)="onDateSelect($event, 'releaseDate')"></nb-datepicker>
          
          <div class="form-actions">
            <button nbButton
              type="submit"
              status="primary"
              [disabled]="distributionForm.invalid"
              (click)="saveDistributionToLocalStorage()">
              {{ isEditingDistribution ? 'Save Changes' : 'Add to List' }}
            </button>
            
            <button *ngIf="isEditingDistribution"
              nbButton
              type="button"
              status="basic"
              class="ml-2"
              (click)="cancelEditDistribution()">
              Cancel
            </button>
          </div>
        </form>
      </nb-card>

        <!-- Right panel: distribution list -->
        <nb-card class="distribution-list-panel m-0">
          <div class="distribution-list-header">
            <div>
              <h4>Distribution list</h4>
              <p *ngIf="distributions.length === 0">No distributions added yet</p>
            </div>
            
          </div>
          <ul>
            <li *ngFor="let dist of distributions; let i = index" class="distribution-item" 
                [class.marked-for-deletion]="dist.markedForDeletion"
                [class.current-editing]="isEditingDistribution && currentEditingDistributionId === dist.id">
              <div>
                <strong>{{ dist.title }} (ID: {{ dist.id }})</strong>
                <p>{{ dist.description }}</p>
                <span *ngIf="dist.markedForDeletion" class="deletion-badge">Pending Deletion</span>
                <span *ngIf="isEditingDistribution && currentEditingDistributionId === dist.id" class="editing-badge">Currently Editing</span>
              </div>
              <div class="distribution-actions">
                <button nbButton 
                      [status]="dist.markedForDeletion ? 'success' : 'danger'"
                      size="small"
                      [disabled]="deletingDistributions[dist.id] || (isEditingDistribution && currentEditingDistributionId === dist.id)" 
                      (click)="dist.markedForDeletion ? undoDeleteDistribution(i) : removeDistribution(i)">
                  <nb-icon *ngIf="!deletingDistributions[dist.id]" 
                           [icon]="dist.markedForDeletion ? 'undo-outline' : 'close-outline'"></nb-icon>
                  <nb-icon *ngIf="deletingDistributions[dist.id]" icon="loader-outline" [spin]="true"></nb-icon>
                </button>
                <button nbButton 
                       status="info" 
                       size="small" 
                       (click)="editDistribution(dist)" 
                       [disabled]="deletingDistributions[dist.id] || dist.markedForDeletion || (isEditingDistribution && currentEditingDistributionId === dist.id)">
                  <nb-icon icon="edit-outline"></nb-icon> Edit
                </button>
              </div>
            </li>
          </ul>
        </nb-card>
      </div>
      <div class="step-controls">
        <button nbButton status="primary" (click)="stepper.next()">
          Next
        </button>
      </div>
    </nb-step>
    
    <!-- Step 2: Create Dataset -->
    <nb-step label="Create dataset">
      <div class="step-content">
        <form [formGroup]="datasetForm" class="dataset-form">
          <div class="left-column">
            <div class="form-group">
              <label for="title">Title <span class="required-indicator">*</span></label>
              <input nbInput fullWidth id="title" formControlName="title">
            </div>

            <div class="form-group">
              <label for="datasetId">ID <span class="required-indicator">*</span></label>
              <input nbInput fullWidth id="datasetId" formControlName="id">
            </div>

            <label>Dataset Description</label>
            <div formArrayName="datasetDescription" class="array-field">
              <div *ngFor="let desc of datasetDescriptions.controls; let i = index" class="array-item">
                <input nbInput [formControlName]="i" type="text" class="full-width-input" />
                <button nbButton status="danger" size="tiny" (click)="removeDatasetDescription(i)">
                  <nb-icon icon="close-outline"></nb-icon>
                </button>
              </div>
              <button nbButton status="info" size="small" (click)="addDatasetDescription()">
                <nb-icon icon="plus-outline"></nb-icon> Add Description
              </button>
            </div>
            
            <label for="description">Description</label>
            <textarea nbInput id="description" formControlName="description" class="full-width-input"></textarea>

            <label>Version Notes</label>
            <div formArrayName="versionNotes" class="array-field">
              <div *ngFor="let note of versionNotesArray.controls; let i = index" class="array-item">
                <input nbInput [formControlName]="i" type="text" class="full-width-input" />
                <button nbButton status="danger" size="tiny" (click)="removeVersionNote(i)">
                  <nb-icon icon="close-outline"></nb-icon>
                </button>
              </div>
              <button nbButton status="info" size="small" (click)="addVersionNote()">
                <nb-icon icon="plus-outline"></nb-icon> Add Version Note
              </button>
            </div>
            
            <label for="version">Version</label>
            <input nbInput id="version" formControlName="version" type="text" class="full-width-input" />
          </div>
          
          <div class="mid-column">
            <label for="name">Name</label>
            <input nbInput id="name" formControlName="name" type="text" class="full-width-input" />
            
            <label for="publisher">Publisher</label>
            <input nbInput id="publisher" formControlName="publisher" type="text" class="full-width-input" />
            
            <label>Contact Points</label>
            <div formArrayName="contactPoint" class="array-field">
              <div *ngFor="let cp of contactPoints.controls; let i = index" class="array-item">
                <input nbInput [formControlName]="i" type="text" class="full-width-input" />
                <button nbButton status="danger" size="tiny" (click)="removeContactPoint(i)">
                  <nb-icon icon="close-outline"></nb-icon>
                </button>
              </div>
              <button nbButton status="info" size="small" (click)="addContactPoint()">
                <nb-icon icon="plus-outline"></nb-icon> Add Contact Point
              </button>
            </div>
            
            <label for="creator">Creator</label>
            <input nbInput id="creator" formControlName="creator" type="text" class="full-width-input" />
            
            <label>Keywords</label>
            <div formArrayName="keyword" class="array-field">
              <div *ngFor="let kw of keywords.controls; let i = index" class="array-item">
                <input nbInput [formControlName]="i" type="text" class="full-width-input" />
                <button nbButton status="danger" size="tiny" (click)="removeKeyword(i)">
                  <nb-icon icon="close-outline"></nb-icon>
                </button>
              </div>
              <button nbButton status="info" size="small" (click)="addKeyword()">
                <nb-icon icon="plus-outline"></nb-icon> Add Keyword
              </button>
            </div>
            
            <div class="form-group">
              <label for="releaseDate">Release Date <span class="required-indicator">*</span></label>
              <input nbInput fullWidth id="releaseDate" formControlName="releaseDate"
                     [nbDatepicker]="datepicker">
              <nb-datepicker #datepicker></nb-datepicker>
            </div>
          </div>
          <div class="right-column">
            <label>Themes</label>
            <div formArrayName="theme" class="array-field">
              <div *ngFor="let themeItem of themes.controls; let i = index" class="array-item">
                <input nbInput [formControlName]="i" type="text" class="full-width-input" />
                <button nbButton status="danger" size="tiny" (click)="removeTheme(i)">
                  <nb-icon icon="close-outline"></nb-icon>
                </button>
              </div>
              <button nbButton status="info" size="small" (click)="addTheme()">
                <nb-icon icon="plus-outline"></nb-icon> Add Theme
              </button>
            </div>
            
            <label for="accessRights">Access Rights</label>
            <nb-select id="accessRights" formControlName="accessRights" class="full-width-input">
              <nb-option value="public">Public</nb-option>
              <nb-option value="non-public">Non-Public</nb-option>
            </nb-select>
            
            <label for="frequency">Frequency</label>
            <nb-select id="frequency" formControlName="frequency" class="full-width-input">
              <nb-option value="DAILY">Daily</nb-option>
              <nb-option value="WEEKLY">Weekly</nb-option>
              <nb-option value="MONTHLY">Monthly</nb-option>
            </nb-select>
            
            <!-- Spatial / map area -->
            <div class="spatial-section">
              <strong>Spatial:</strong><span class="required-indicator">*</span>
              <div formArrayName="spatial" *ngFor="let point of spatialPoints.controls; let i = index">
                <div [formGroupName]="i" class="spatial-point">
                  <div formArrayName="coordinates" class="coordinates-input">
                    <div class="coordinate">
                      <label>Longitude:</label>
                      <input nbInput type="number" step="0.000001" [formControlName]="0" class="full-width-input" />
                    </div>
                    <div class="coordinate">
                      <label>Latitude:</label>
                      <input nbInput type="number" step="0.000001" [formControlName]="1" class="full-width-input" />
                    </div>
                  </div>
                </div>
              </div>
              <div id="map"></div>
            </div>
          </div>
        </form>
      </div>
      <div class="step-controls">
        <button nbButton status="primary" (click)="stepper.previous()">
          Back
        </button>
        <button nbButton 
          status="success" 
          [disabled]="datasetForm.invalid || distributions.length === 0 || isCreatingDataset"
          (click)="createDatasetWithDistributions()">
          <nb-icon *ngIf="isCreatingDataset" icon="loader-outline" [spin]="true"></nb-icon>
          {{ isEditing ? 'Update dataset' : 'Create dataset' }}
        </button>
      </div>
    </nb-step>
  </nb-stepper>
</div>
